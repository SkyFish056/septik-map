<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Карта дилеров</title>
    
    <!-- Мета-теги для ВКонтакте -->
    <meta property="og:title" content="Карта дилеров">
    <meta property="og:description" content="Найдите официальных дилеров в вашем городе">
    <meta property="og:image" content="https://skyfish056.github.io/septik-map/preview.jpg">
    <meta property="og:url" content="https://skyfish056.github.io/septik-map/">
    <meta property="vk:image" content="https://skyfish056.github.io/septik-map/preview.jpg">
    
    <!-- API Яндекс.Карт -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=888ae0cd-1515-4762-9738-a15768a83edf&lang=ru_RU"></script>
    
    <!-- VK Bridge (обязательно для Mini Apps) -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden;
        }
        #city-filter {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 999;
            background: rgba(255,255,255,0.95);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(4px);
        }
        #city-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            min-width: 220px;
            font-size: 16px;
            background: #fff;
        }
        .vk-back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 999;
            background: rgba(255,255,255,0.95);
            padding: 10px 16px;
            border-radius: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            backdrop-filter: blur(4px);
            border: none;
        }
        .vk-back-btn:hover {
            background: #f8f8f8;
        }
        .vk-back-btn.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Основной контейнер карты -->
    <div id="map"></div>
    
    <!-- Фильтр по городам -->
    <div id="city-filter">
        <select id="city-select">
            <option value="">Все города</option>
            <!-- Города загрузятся автоматически -->
        </select>
    </div>
    
    <!-- Кнопка "Назад" для ВК -->
    <button class="vk-back-btn hidden" id="backBtn">
        ← Назад
    </button>

    <script>
        // ======================= VK MINI APPS ИНИЦИАЛИЗАЦИЯ =======================
        // Обязательная инициализация VK Bridge
        document.addEventListener('DOMContentLoaded', async () => {
            // Проверяем, открыто ли в VK Mini Apps
            const isVK = typeof vkBridge !== 'undefined';
            
            if (isVK) {
                // 1. Инициализация приложения (ОБЯЗАТЕЛЬНЫЙ ШАГ)
                await vkBridge.send('VKWebAppInit');
                
                // 2. Включаем свайп назад (рекомендуется)
                await vkBridge.send('VKWebAppEnableSwipeBack');
                
                // 3. Настраиваем интерфейс под VK
                document.body.classList.add('vk-app');
                document.getElementById('backBtn').classList.remove('hidden');
                
                // 4. Получаем параметры запуска (если нужно)
                const launchParams = await vkBridge.send('VKWebAppGetLaunchParams');
                console.log('Параметры запуска:', launchParams);
                
                // 5. Устанавливаем тему приложения
                const appearance = await vkBridge.send('VKWebAppGetAppearance');
                setTheme(appearance);
                
                // Следим за сменой темы
                vkBridge.subscribe((e) => {
                    if (e.detail.type === 'VKWebAppUpdateConfig') {
                        setTheme(e.detail.data.scheme);
                    }
                });
            }
            
            // Инициализируем карту после загрузки VK
            ymaps.ready(() => initMap(isVK));
        });

        // Обработчик кнопки "Назад"
        document.getElementById('backBtn').addEventListener('click', async () => {
            if (typeof vkBridge !== 'undefined') {
                // Закрываем приложение
                await vkBridge.send('VKWebAppClose', { status: 'success' });
            } else if (window.history.length > 1) {
                history.back();
            } else {
                window.close();
            }
        });

        // Установка темы оформления
        function setTheme(scheme) {
            const isDark = scheme === 'space_gray' || scheme === 'vk_dark';
            document.documentElement.style.setProperty('--bg-color', isDark ? '#19191A' : '#FFFFFF');
            document.documentElement.style.setProperty('--text-color', isDark ? '#E1E3E6' : '#19191A');
        }

        // ======================= ОСНОВНОЙ КОД КАРТЫ =======================
        async function initMap(isVKApp) {
            try {
                // Создаем карту
                const map = new ymaps.Map('map', {
                    center: [55.76, 37.64],
                    zoom: 4,
                    controls: ['zoomControl', isVKApp ? '' : 'searchControl'].filter(Boolean)
                });

                // Загрузка данных
                const dealers = await loadDealers();
                
                // Инициализация фильтра
                initCityFilter(dealers, map);
                
                // Добавление меток на карту
                addDealersToMap(map, dealers);

            } catch (error) {
                console.error('Ошибка инициализации:', error);
                
                // Отправка ошибки в VK
                if (typeof vkBridge !== 'undefined') {
                    await vkBridge.send('VKWebAppReportError', {
                        error_type: 'map_init_error',
                        error_message: error.message
                    });
                }
                
                alert('Произошла ошибка при загрузке карты. Пожалуйста, попробуйте позже.');
            }
        }

        // Функция загрузки данных с кешированием
        async function loadDealers() {
            try {
                const response = await fetch('https://skyfish056.github.io/septik-map/dealers.json?v=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                // Пробуем загрузить из кеша, если есть
                const cachedData = localStorage.getItem('dealersCache');
                if (cachedData) {
                    return JSON.parse(cachedData);
                }
                throw error;
            }
        }

        // Инициализация фильтра по городам
        function initCityFilter(dealers, map) {
            const citySelect = document.getElementById('city-select');
            
            // Получаем уникальные города
            const cities = [...new Set(dealers.map(d => d.city).filter(Boolean))];
            cities.sort();
            
            // Заполняем select
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
            
            // Обработчик изменения фильтра
            citySelect.addEventListener('change', function() {
                const selectedCity = this.value;
                const placemarks = map.geoObjects;
                
                if (!selectedCity) {
                    placemarks.each(placemark => placemark.options.set('visible', true));
                } else {
                    placemarks.each(placemark => {
                        const city = placemark.properties.get('balloonContent').match(/Город:<\/b> (.*?)<br>/)?.[1];
                        placemark.options.set('visible', city === selectedCity);
                    });
                }
                
                // Автомасштабирование
                const visiblePlacemarks = placemarks.filter(placemark => placemark.options.get('visible'));
                if (visiblePlacemarks.getLength() > 0) {
                    map.setBounds(visiblePlacemarks.getBounds(), { checkZoomRange: true });
                }
            });
        }

        // Добавление меток на карту
        function addDealersToMap(map, dealers) {
            const objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 64,
                clusterDisableClickZoom: true,
                clusterIconLayout: 'default#pieChart'
            });
            
            // Преобразование данных
            const features = dealers.map(dealer => ({
                type: 'Feature',
                id: dealer.id,
                geometry: {
                    type: 'Point',
                    coordinates: dealer.coords
                },
                properties: {
                    balloonContentHeader: dealer.name,
                    balloonContentBody: `
                        <div style="margin: 8px 0">
                            <b>Город:</b> ${dealer.city}<br>
                            <b>Адрес:</b> ${dealer.address || 'Не указан'}<br>
                            <b>Телефон:</b> <a href="tel:${dealer.phone}" style="color: #07f">${dealer.phone}</a>
                        </div>
                        ${dealer.email ? `<div><b>Email:</b> <a href="mailto:${dealer.email}" style="color: #07f">${dealer.email}</a></div>` : ''}
                    `,
                    clusterCaption: dealer.city,
                    hintContent: dealer.name
                }
            }));
            
            objectManager.add({
                type: 'FeatureCollection',
                features: features
            });
            
            map.geoObjects.add(objectManager);
            
            // Автомасштабирование
            if (features.length > 0) {
                map.setBounds(objectManager.getBounds(), { checkZoomRange: true });
            }
        }
    </script>
</body>
</html>
