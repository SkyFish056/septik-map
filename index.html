<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Карта дилеров</title>
    
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    
    <style>
        html, body, #map-container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, system-ui, sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #city-filter {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 999;
            background: rgba(255,255,255,0.95);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(4px);
        }
        #city-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            width: 200px;
            font-size: 16px;
            background: #fff;
            appearance: none;
        }
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div id="city-filter">
            <select id="city-select" disabled>
                <option value="">Загрузка...</option>
            </select>
        </div>
        <div class="loader" id="loader">Загрузка карты...</div>
    </div>

    <script>
        // Инициализация VK Bridge
        document.addEventListener('DOMContentLoaded', async () => {
            const isVK = typeof vkBridge !== 'undefined';
            
            if (isVK) {
                try {
                    // 1. Обязательная инициализация
                    await vkBridge.send('VKWebAppInit');
                    
                    // 2. Включаем свайп назад
                    await vkBridge.send('VKWebAppEnableSwipeBack');
                    
                    // 3. Получаем параметры запуска
                    const launchParams = await vkBridge.send('VKWebAppGetLaunchParams');
                    console.log('Launch params:', launchParams);
                    
                } catch (error) {
                    console.error('VK Bridge error:', error);
                }
            }
            
            // Динамическая загрузка API Яндекс.Карт
            loadYandexMaps(isVK);
        });

        // Загрузка API Яндекс.Карт с обработкой ошибок
        function loadYandexMaps(isVKApp) {
            const script = document.createElement('script');
            script.src = `https://api-maps.yandex.ru/2.1/?apikey=888ae0cd-1515-4762-9738-a15768a83edf&lang=ru_RU&load=package.full`;
            script.onload = () => ymaps.ready(() => initMap(isVKApp));
            script.onerror = () => {
                document.getElementById('loader').textContent = 'Ошибка загрузки карт';
                console.error('Failed to load Yandex Maps');
            };
            document.head.appendChild(script);
        }

        // Основная функция инициализации карты
        async function initMap(isVKApp) {
            try {
                const loader = document.getElementById('loader');
                loader.textContent = 'Загрузка данных...';
                
                // Создаем карту
                const map = new ymaps.Map('map', {
                    center: [55.76, 37.64],
                    zoom: 4,
                    controls: ['zoomControl']
                });
                
                // Фикс для iframe в VK
                if (isVKApp) {
                    map.container.fitToViewport();
                    window.addEventListener('resize', () => map.container.fitToViewport());
                }
                
                // Загрузка данных
                const dealers = await loadDealers();
                loader.remove();
                
                // Инициализация фильтра
                initCityFilter(dealers, map);
                
                // Добавление меток
                addDealersToMap(map, dealers);
                
            } catch (error) {
                console.error('Map init error:', error);
                document.getElementById('loader').textContent = 'Ошибка загрузки';
                
                if (typeof vkBridge !== 'undefined') {
                    await vkBridge.send('VKWebAppReportError', {
                        error_type: 'map_init_failed',
                        error_message: error.message
                    });
                }
            }
        }

        // Загрузка данных с CORS-прокси
        async function loadDealers() {
            try {
                // Прямой запрос с кешированием
                const response = await fetch('https://skyfish056.github.io/septik-map/dealers.json?t=' + Date.now(), {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                return await response.json();
                
            } catch (error) {
                console.warn('Using CORS proxy for dealers.json');
                
                // Fallback через CORS-прокси
                const proxyUrl = `https://cors-anywhere.herokuapp.com/https://skyfish056.github.io/septik-map/dealers.json`;
                const proxyResponse = await fetch(proxyUrl, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                
                if (!proxyResponse.ok) throw new Error('Failed to load via proxy');
                return await proxyResponse.json();
            }
        }

        // Инициализация фильтра городов
        function initCityFilter(dealers, map) {
            const select = document.getElementById('city-select');
            select.innerHTML = '<option value="">Все города</option>';
            
            const cities = [...new Set(dealers.map(d => d.city).filter(Boolean))];
            cities.sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
            
            select.disabled = false;
            select.addEventListener('change', () => filterByCity(map, select.value));
        }

        // Фильтрация по городу
        function filterByCity(map, city) {
            const objects = map.geoObjects;
            objects.each(obj => {
                const props = obj.properties;
                const isMatch = !city || props.get('balloonContent').includes(`Город:</b> ${city}<br>`);
                obj.options.set('visible', isMatch);
            });
            
            if (city) {
                const visible = objects.filter(obj => obj.options.get('visible'));
                if (visible.getLength() > 0) {
                    map.setBounds(visible.getBounds(), { checkZoomRange: true });
                }
            }
        }

        // Добавление меток на карту
        function addDealersToMap(map, dealers) {
            const objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 64,
                clusterDisableClickZoom: true
            });
            
            objectManager.add({
                type: 'FeatureCollection',
                features: dealers.map(dealer => ({
                    type: 'Feature',
                    id: dealer.id,
                    geometry: {
                        type: 'Point',
                        coordinates: dealer.coords
                    },
                    properties: {
                        balloonContent: `
                            <b>${dealer.name}</b><br>
                            <b>Город:</b> ${dealer.city}<br>
                            <b>Адрес:</b> ${dealer.address || 'Не указан'}<br>
                            <b>Телефон:</b> <a href="tel:${dealer.phone}">${dealer.phone}</a><br>
                            ${dealer.email ? `<b>Email:</b> <a href="mailto:${dealer.email}">${dealer.email}</a>` : ''}
                        `,
                        clusterCaption: dealer.city,
                        hintContent: dealer.name
                    }
                }))
            });
            
            map.geoObjects.add(objectManager);
            
            if (dealers.length > 0) {
                map.setBounds(objectManager.getBounds(), { checkZoomRange: true });
            }
        }
    </script>
</body>
</html>
